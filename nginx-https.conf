# HTTP server - still works but Cache API won't be available
server {
    listen 80;
    server_name localhost;
    
    root /usr/share/nginx/html;
    index index.html;
    
    # Gzip compression for text files
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/javascript application/json;
    
    # Default location
    location / {
        try_files $uri $uri/ =404;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "no-cache";
    }
    
    # JavaScript - allow caching but revalidate
    location ~* \.js$ {
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "public, max-age=3600, must-revalidate";
    }
    
    # Landsandboat data
    location /ffxi/landsandboat/ {
        alias /usr/share/nginx/html/landsandboat/;
        gzip off;
        add_header Accept-Ranges bytes;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "public, max-age=604800, immutable";
        try_files $uri =404;
    }
    
    # FFXI game data folder
    location /ffxi/ {
        alias /usr/share/nginx/html/ffxi/;
        gzip off;
        add_header Accept-Ranges bytes;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "public, max-age=604800, immutable";
        try_files $uri =404;
    }
    
    # Images - long cache
    location ~* \.(png|jpg|jpeg|gif|ico)$ {
        add_header Cache-Control "public, max-age=604800, immutable";
    }
    
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
}

# HTTPS server
server {
    listen 443 ssl;
    server_name localhost;
    
    # SSL certificate configuration
    ssl_certificate /etc/nginx/ssl/nginx.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.key;
    
    # SSL settings (modern configuration)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    root /usr/share/nginx/html;
    index index.html;
    
    # Gzip compression for text files
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/javascript application/json;
    
    # Default location
    location / {
        try_files $uri $uri/ =404;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "no-cache";
    }
    
    # JavaScript - allow caching but revalidate
    location ~* \.js$ {
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "public, max-age=3600, must-revalidate";
    }
    
    # Landsandboat data - served from separate location (not affected by FFXI mount)
    # This MUST come before the /ffxi/ location to take precedence
    location /ffxi/landsandboat/ {
        alias /usr/share/nginx/html/landsandboat/;
        gzip off;
        add_header Accept-Ranges bytes;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "public, max-age=604800, immutable";
        try_files $uri =404;
    }
    
    # FFXI game data folder (ROM, ROM2-9, sound, VTABLE, FTABLE, etc.)
    # This serves the mounted FFXI folder
    location /ffxi/ {
        alias /usr/share/nginx/html/ffxi/;
        gzip off;
        add_header Accept-Ranges bytes;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "public, max-age=604800, immutable";
        
        # Handle missing files gracefully
        try_files $uri =404;
    }
    
    # Images - long cache
    location ~* \.(png|jpg|jpeg|gif|ico)$ {
        add_header Cache-Control "public, max-age=604800, immutable";
    }
    
    # Logging (optional - comment out to reduce disk writes)
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
}
